<html xmlns="http://www.w3.org/1999/xhtml"> 
  <!--
    Copyright 2010-2011 Fabric Technologies Inc. All rights reserved.
    -->
  <head> 
    <title>FABRIC - Volume Rendering</title> 
    
    <meta charset="iso-8859-1"/>
    <link href="../../../themes/default/style.css" rel="stylesheet" type="text/css" />
    <link href="../../../themes/default/viewer.css" rel="stylesheet" type="text/css" />
    
    <script type="text/javascript" src="../../../ThirdParty/jQuery/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="../../../ThirdParty/jQuery/jquery-ui-1.8.5.custom.min.js"></script>

    <link type="text/css" href="../../../ThirdParty/jQuery/css/vader/jquery-ui-1.8.5.custom.css" rel="stylesheet" />

    <script type="text/javascript" src="../../../Core/FABRIC.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Math.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Vec2.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Vec3.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Vec4.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Mat22.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Mat33.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Mat44.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Quat.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Xfo.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/RGBA.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Color.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Euler.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLShaderProgram.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLTexture2D.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLTexture3D.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLBuffer.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLRenderTarget.js" charset="utf-8"></script>

    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Geometry.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Primitives.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Lights.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Materials.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Manipulation.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Kinematics.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Rendering.js" charset="utf-8"></script>
    
<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-25833362-1']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(ga, s);
 })();

</script>

    <script type="text/javascript">

FABRIC.SceneGraph.registerNodeType('3DTextureGenerator', {
  briefDesc: '',
  detailedDesc: '',
  parentNodeDesc: 'Scene',
  optionsDesc: {
  },
  factoryFn: function(options, scene) {
    scene.assignDefaults(options, {
        resolution: 128
      });

    options.name = '3DTextureGenerator_Opacity';
    options.format = 'Byte';
    options.createDgNode = true;
    var generatorNodeOpacity = scene.constructNode('Image3D', options);
    var dgnodeOpacity = generatorNodeOpacity.getDGNode();

    dgnodeOpacity.addMember('resolution', 'Size', options.resolution );
    generatorNodeOpacity.addMemberInterface(dgnodeOpacity, 'resolution', true);

    dgnodeOpacity.bindings.append(scene.constructOperator({
      operatorName: 'generate3DTextureOpacity',
      parameterLayout: [
        'self.resolution',
        'self.width',
        'self.height',
        'self.depth',
        'self.pixels'
      ],
      entryFunctionName: 'generate3DTextureOpacity',
      srcFile: 'KL/3DTextureUtils.kl'
    }));

    options.name = '3DTextureGenerator_Gradient';
    options.format = 'RGBA';
    options.color = undefined;
    var generatorNodeGradientPub = scene.pub.constructNode('Image3D', options);
    var generatorNodeGradient = scene.getPrivateInterface(generatorNodeGradientPub);
    var dgnodeGradient = generatorNodeGradient.getDGNode();
    dgnodeGradient.setDependency(dgnodeOpacity, 'opacity');

    dgnodeGradient.bindings.append(scene.constructOperator({
      operatorName: 'generate3DTextureGradient',
      parameterLayout: [
        'opacity.resolution',
        'self.width',
        'self.height',
        'self.depth',
        'self.pixels'
      ],
      entryFunctionName: 'generate3DTextureGradient',
      srcFile: 'KL/3DTextureUtils.kl'
    }));

    generatorNodeOpacity.getOpacityDGNode = function(){return dgnodeOpacity;};
    generatorNodeOpacity.getGradientDGNode = function(){return dgnodeGradient;};

    generatorNodeOpacity.pub.getGradientNode = function(){return generatorNodeGradientPub;};

    return generatorNodeOpacity;
  }
});

FABRIC.SceneGraph.registerNodeType('DrawRectangle', {
  briefDesc: '',
  detailedDesc: '',
  parentNodeDesc: 'Image',
  optionsDesc: {
    tl: 'Top left screenspace coord',
    br: 'Bottom right screenspace coord',
    color: 'Rectangle color'
  },

  factoryFn: function(options, scene) {
    scene.assignDefaults(options, {
        tl: new FABRIC.RT.Vec2(-1.0, 1.0),
        br: new FABRIC.RT.Vec2(1.0, -1.0),
        color: new FABRIC.RT.RGBA(255, 255, 255, 255),
        forceRefresh: false
      });

    options.wantHDR = false;
    options.createDgNode = true;
    options.createResourceLoadNode = false;
    options.createLoadTextureEventHandler = true;

    var rectangleImageNode = scene.constructNode('Image', options);
    var dgnode = rectangleImageNode.getDGNode();

    var postDrawEventHandler = rectangleImageNode.constructEventHandlerNode('PostDraw');
    postDrawEventHandler.appendChildEventHandler(rectangleImageNode.getRedrawEventHandler());

    postDrawEventHandler.addMember('tl', 'Vec2', options.tl );
    postDrawEventHandler.addMember('br', 'Vec2', options.br );

    rectangleImageNode.addMemberInterface(postDrawEventHandler, 'tl', true);
    rectangleImageNode.addMemberInterface(postDrawEventHandler, 'br', true);

    postDrawEventHandler.setScopeName('textureStub');
    postDrawEventHandler.addMember('textureUnit', 'Integer', 0);
    postDrawEventHandler.addMember('program', 'Integer', 0);
    postDrawEventHandler.postDescendBindings.append(
      scene.constructOperator({
          operatorName: 'drawTexture',
          srcFile: 'FABRIC_ROOT/SceneGraph/KL/drawTexture.kl',
          entryFunctionName: 'drawTextureAt',
          parameterLayout: [
            'self.tl',
            'self.br',
            'self.textureUnit',
            'self.program'
          ]
        }
    ));

    var enabled = false;
    rectangleImageNode.pub.enable = function() {
      if(!enabled) {
        scene.getScenePostRedrawEventHandler().appendChildEventHandler(postDrawEventHandler);
        enabled = true;
      }
    };

    rectangleImageNode.pub.disable = function() {
      if(enabled) {
        scene.getScenePostRedrawEventHandler().removeChildEventHandler(postDrawEventHandler);
        enabled = false;
      }
    };
    rectangleImageNode.pub.enable();
    return rectangleImageNode;
  }
});

FABRIC.SceneGraph.registerNodeType('Texture2DSliceDisplay', {
  briefDesc: '',
  detailedDesc: '',
  parentNodeDesc: 'DrawRectangle',
  optionsDesc: {
    sourceImageNode: 'The source 3D image node',
    sliceRatio: 'Slice ratio (0 to 1) along sliceAxis',
    sliceAxis: 'Slice axis (0=X, 1=Y, 2=Z) along which the image is extracted',
    opacityElseGradientWeight: 'Show opacity, else will be gradient weight'
  },

  factoryFn: function(options, scene) {
    scene.assignDefaults(options, {
        sliceRatio: 0.5,
        sliceAxis: 0,
        opacityElseGradientWeight: true
      });

    options.forceRefresh = true;
    var sliceDisplayNode = scene.constructNode('DrawRectangle', options);
    var dgnode = sliceDisplayNode.getDGNode();

    dgnode.addMember('sliceRatio', 'Scalar', options.sliceRatio );
    dgnode.addMember('sliceAxis', 'Size', options.sliceAxis );
    dgnode.addMember('opacityElseGradientWeight', 'Boolean', options.opacityElseGradientWeight );

    sliceDisplayNode.addMemberInterface(dgnode, 'sliceRatio', true);
    sliceDisplayNode.addMemberInterface(dgnode, 'sliceAxis', true);
    sliceDisplayNode.addMemberInterface(dgnode, 'opacityElseGradientWeight', true);

    var sourceImageNode = scene.getPrivateInterface(options.sourceImageNode);
    dgnode.setDependency(sourceImageNode.getOpacityDGNode(), 'sourceOpacity');
    dgnode.setDependency(sourceImageNode.getGradientDGNode(), 'sourceGradient');
    
    dgnode.bindings.append(scene.constructOperator({
      operatorName: 'slice3DTexture',
      parameterLayout: [
        'self.sliceRatio',
        'self.sliceAxis',
        'self.opacityElseGradientWeight',
        'sourceOpacity.width',
        'sourceOpacity.height',
        'sourceOpacity.depth',
        'sourceOpacity.pixels',
        'sourceGradient.pixels',
        'self.width',
        'self.height',
        'self.pixels'
      ],
      entryFunctionName: 'slice3DTexture',
      srcFile: 'KL/3DTextureUtils.kl'
    }));

    return sliceDisplayNode;
  }
});
    
$(document).ready(function() {
  var i, j;
  var $sliders3D = [
      $('#rangeX3D').slider({min: 0, max: 1, step: 0.005, range: true, values: [0,1] }),
      $('#rangeY3D').slider({min: 0, max: 1, step: 0.005, range: true, values: [0,1] }),
      $('#rangeZ3D').slider({min: 0, max: 1, step: 0.005, range: true, values: [0,1] })
  ];
  var $opacityFactorSlider = $('#opacityFactor').slider({min: 0, max: 1, step: 0.01, value: 0.5 });
  var $resolutionFactorSlider = $('#resolutionFactor').slider({min: 0.01, max: 1, step: 0.01, value: 0.5 });

  var $sliders2D = [
    $('#xRatio').slider({min: 0, max: 1, step: 0.005 }),
    $('#yRatio').slider({min: 0, max: 1, step: 0.005 }),
    $('#zRatio').slider({min: 0, max: 1, step: 0.005 })
  ];

  var scene = FABRIC.SceneGraph.createScene();
  var viewport = scene.constructNode('Viewport', {
    windowElement: document.getElementById('FabricContainer'),
    backgroundColor: FABRIC.RT.rgb(0.0, 0.05, 0.15)
  });
  
  // Create a camera to draw the scene from
  var camera = scene.constructNode('TargetCamera', {
      position: new FABRIC.RT.Vec3(0, 0, 20),
      target: new FABRIC.RT.Vec3(0, 0, 0),
      screenOffset: new FABRIC.RT.Vec2(-0.25, 0.0)
    });

  scene.constructNode("CameraManipulator", { targetNode:camera } );
  viewport.setCameraNode(camera);

//  var light = scene.constructNode('PointLight', { position: new FABRIC.RT.Vec3(420.0, 1000.0, 600.0) });
  var transform =  scene.constructNode('Transform', {
    hierarchical: false,
    globalXfo: new FABRIC.RT.Xfo({ tr: new FABRIC.RT.Vec3(0, 0, 0), sc: new FABRIC.RT.Vec3(5.0, 5.0, 5.0) })
  });

  var layoutRectangle = scene.constructNode('DrawRectangle', {color: new FABRIC.RT.RGBA(128,128,128,255), tl: new FABRIC.RT.Vec2(2.0/3.0, 1.0), br: new FABRIC.RT.Vec2(1.0, -1.0) });
  var borderSize = 0.01;

  var textureGen = scene.constructNode('3DTextureGenerator');
  var texture2DSlice = [];
  texture2DSlice[0] = scene.constructNode('Texture2DSliceDisplay', {tl: new FABRIC.RT.Vec2(2.0/3.0+borderSize, 1.0-borderSize), br: new FABRIC.RT.Vec2(1.0-borderSize, 1.0/3.0+borderSize), sourceImageNode: textureGen, sliceRatio: 0.5, sliceAxis : 0});
  texture2DSlice[1] = scene.constructNode('Texture2DSliceDisplay', {tl: new FABRIC.RT.Vec2(2.0/3.0+borderSize, 1.0/3.0-borderSize), br: new FABRIC.RT.Vec2(1.0-borderSize, -1.0/3.0+borderSize), sourceImageNode: textureGen, sliceRatio: 0.5, sliceAxis : 1});
  texture2DSlice[2] = scene.constructNode('Texture2DSliceDisplay', {tl: new FABRIC.RT.Vec2(2.0/3.0+borderSize, -1.0/3.0-borderSize), br: new FABRIC.RT.Vec2(1.0-borderSize, -1.0+borderSize), sourceImageNode: textureGen, sliceRatio: 0.5, sliceAxis : 2});

  var volumeNode = scene.constructNode('VolumeOpacityInstance', {
      viewportNode: viewport,
      transformNode: transform,
      cropMin: new FABRIC.RT.Vec3(0, 0, 0),
      cropMax: new FABRIC.RT.Vec3(1, 1, 1),
      opacityTextureNode: textureGen
//      gradientTextureNode: textureGen.getGradientNode(),
//      lightNode: light
    });
    
  var sliders2DBindFunction = function(index) {
    var sliderIndex = index;
    return function(event, ui) {
        texture2DSlice[sliderIndex].setSliceRatio(ui.value);
        viewport.redraw();
        return true;
      };
  };

  var sliders3DBindFunction = function(index) {
    var sliderIndex = index;
    return function(event, ui) {
        var min = volumeNode.getCropMin(), max = volumeNode.getCropMax();
        min.setComponent( sliderIndex, ui.values[0] );
        max.setComponent( sliderIndex, ui.values[1] );
        volumeNode.setCropMin(min);
        volumeNode.setCropMax(max);
        viewport.redraw();
        return true;
      };
  };

  for( i = 0; i < 3; ++i ) {
    $sliders2D[i].slider('value', texture2DSlice[i].getSliceRatio());
    $sliders2D[i].bind('slide', sliders2DBindFunction(i) );
    
    var cropMax = volumeNode.getCropMax();
    var cropMin = volumeNode.getCropMin();
    $sliders3D[i].slider('option', 'values', [cropMin.component(i), cropMax.component(i)]);
    $sliders3D[i].bind('slide', sliders3DBindFunction(i) );
  }

  $resolutionFactorSlider.slider('value', volumeNode.getResolutionFactor());
  $resolutionFactorSlider.bind('slide', function(event, ui) {
    volumeNode.setResolutionFactor(ui.value);
    viewport.redraw();
    viewport.redraw();//For some reason it takes 2 redraw to get the properly ajusted opacity factor upadted to the shader (???)
    return true;
  });
  
  $opacityFactorSlider.slider('value', volumeNode.getOpacityFactor());
  $opacityFactorSlider.bind('slide', function(event, ui) {
    volumeNode.setOpacityFactor(ui.value);
    viewport.redraw();
    viewport.redraw();//For some reason it takes 2 redraw to get the properly ajusted opacity factor upadted to the shader (???)
    return true;
  });
  
  $("#displayGradientWeight").attr('checked', false).change(function() {
    var displayGradientWeight = $('#displayGradientWeight').attr('checked');
    for( i = 0; i < 3; ++i ) {
      texture2DSlice[i].setOpacityElseGradientWeight(!displayGradientWeight);
    }
    viewport.redraw();
  });

  var ajustViewportLayout = function() {
    var displayAxisSlices = $('#displayAxisSlices').attr('checked');
    if(displayAxisSlices) {
      var aspectRatio = viewport.getWidth() / viewport.getHeight();
      var sliceViewWidth = (2.0/3.0) / aspectRatio;
      var tl;
      for( i = 0; i < 3; ++i ) {
        tl = texture2DSlice[i].getTl();
        tl.x = 1.0 - (sliceViewWidth - borderSize);
        texture2DSlice[i].setTl(tl);
      }
      tl = layoutRectangle.getTl();
      tl.x = 1.0 - sliceViewWidth;
      layoutRectangle.setTl(tl);
      camera.setScreenOffset(new FABRIC.RT.Vec2(-sliceViewWidth/2.0, 0.0));
    }
    else
      camera.setScreenOffset(new FABRIC.RT.Vec2(0.0, 0.0));
    viewport.redraw();
  };

  $("#displayAxisSlices").attr('checked', true).change(function() {
    var displayAxisSlices = $('#displayAxisSlices').attr('checked');
    if(displayAxisSlices)
      layoutRectangle.enable();
    else
      layoutRectangle.disable();

    for( i = 0; i < 3; ++i ) {
      if(displayAxisSlices)
        texture2DSlice[i].enable();
      else
        texture2DSlice[i].disable();
    }

    $("#axisSlicesParams").attr('hidden', !displayAxisSlices);
    ajustViewportLayout();
  });
  
  $('#loadingDialog').dialog({
    modal: true
  });
  FABRIC.appendOnResolveAsyncTaskCallback(function(label, nbRemaining, doneWeight, totalWeight) {
    $('#loadingProgressBar').progressbar({
      value: (1.0-(doneWeight/totalWeight))*100
    });
    if (nbRemaining===0) {
      $('#loadingDialog').dialog('close');
      var errors = scene.getErrors();
      if (errors.length > 0) {
        throw (errors.toString());
      }
      ajustViewportLayout();
      return true;
    }
  });
  
});

// jQuert UI Styling classes
$(document).ready(function() {
	$(".box").addClass("ui-widget");
	$(".box h2").addClass("ui-widget-header ui-corner-all");
	$(".content").addClass("ui-widget-content");
});

</script>

  </head> 
  <body>
    <div id="loadingDialog" title="Loading...">
      <h4 id="loadingDesc" style="margin-bottom: 10px"></h4>
      <div id="loadingProgressBar" class="ui-progressbar-value"></div>
    </div>
    <div id="wrapper">
      <ul id="nav">
        <li><a href="#" id="fabric-logo"><img src="../../../themes/default/_img/projects/fabric-logo.png" /></a></li>
      </ul>
      <div id="editor">
        <div id="viewer">
          <div id="FabricContainer"></div> 
        </div><!--viewer-->
        <div id="sidebar">
          
          <div class="box">
            <h2>Volume cropping</h2>
            <div class="content">
              <label for="rangeX3D" >X:</label>
              <div id='rangeX3D' style="margin-top:10px;"></div>
              <label for="rangeY3D" >Y:</label>
              <div id='rangeY3D' style="margin-top:10px;"></div>
              <label for="rangeZ3D" >Z:</label>
              <div id='rangeZ3D' style="margin-top:10px;"></div>
            </div><!--content-->
            <h2>Volume render options</h2>
            <div class="content">
              <label for="opacityFactor" >Opacity factor:</label>
              <div id='opacityFactor' style="margin-top:10px;"></div>
              <label for="resolutionFactor" >Depth resolution factor:</label>
              <div id='resolutionFactor' style="margin-top:10px;"></div>
            </div><!--content-->
            <h2>Axis slices</h2>
            <div class="content">
              <input type="checkbox" id="displayAxisSlices" style="margin-top:10px;" /><label for="displayAxisSlices" style="margin-top:10px;" >Display axis slices</label><br>
              <div class="subcontent" id="axisSlicesParams">
                <input type="checkbox" id="displayGradientWeight" style="margin-top:10px;" /><label for="displayGradientWeight" style="margin-top:10px;" >Display gradient weight</label><br>
                <label for="xRatio" >X:</label>
                <div id='xRatio' style="margin-top:10px;"></div>
                <label for="yRatio" >Y:</label>
                <div id='yRatio' style="margin-top:10px;"></div>
                <label for="zRatio" >Z:</label>
                <div id='zRatio' style="margin-top:10px;"></div>
            </div><!--subcontent-->
            </div><!--content-->
          </div><!--box-->
            
        </div><!--sidebar-->
      </div> <!--editor-->
    </div><!--wrapper-->
  </body> 
  </html>
